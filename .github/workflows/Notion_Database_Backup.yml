name: Notion Database Backup

on:
  schedule:
    # Runs at 8:00 UTC every Monday. You can change this.
    - cron: '0 8 * * 1'
  workflow_dispatch: # Allows you to run it manually

jobs:
  backup:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Notion SDK (Pinned Version)
        run: npm install @notionhq/client@2.2.14

      - name: Create script to fetch JSON
        run: |
          cat <<'EOF' > fetch_json.js
          const { Client } = require('@notionhq/client');
          const fs = require('fs');
          const notion = new Client({ auth: process.env.NOTION_API_KEY });
          const databases = {
            'tools.json': process.env.NOTION_TOOLS_DB_ID,
            'literature.json': process.env.NOTION_LITERATURE_DB_ID,
            'training.json': process.env.NOTION_TRAINING_DB_ID,
            'use_cases.json': process.env.NOTION_USE_CASES_DB_ID
          };
          async function fetchAllPages(databaseId) {
            let results = [];
            let hasMore = true;
            let startCursor = undefined;
            while (hasMore) {
              const response = await notion.databases.query({
                database_id: databaseId,
                start_cursor: startCursor,
              });
              results = results.concat(response.results);
              hasMore = response.has_more;
              startCursor = response.next_cursor;
            }
            return results;
          }
          async function backup() {
            for (const [fileName, dbId] of Object.entries(databases)) {
              if (dbId) {
                console.log(`Fetching data for ${fileName}...`);
                const pages = await fetchAllPages(dbId);
                fs.writeFileSync(fileName, JSON.stringify(pages, null, 2));
                console.log(`Successfully saved ${fileName}`);
              }
            }
          }
          backup();
          EOF

      - name: Step 1: Fetch and Save Notion Data as JSON
        run: node fetch_json.js
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_TOOLS_DB_ID: ${{ secrets.NOTION
